#!/bin/bash

set -e

safe_tput() {
  if [ -n "$TERM" ] && [ "$TERM" != "dumb" ]; then
    tput "$@"
  fi
}
CYAN=$(safe_tput setaf 6)
GREEN=$(safe_tput setaf 2)
RESET=$(safe_tput sgr0)

REPO_ROOT=$(git rev-parse --show-toplevel)

function check_error {
  if [ $? -ne 0 ]; then
    exit 1
  fi
}

if test -z "$(git ls-files --exclude-standard --others)" && git diff-files --quiet; then
  # no unstaged changes, run format
  echo "${CYAN}[pre-commit]${RESET} üßπ Running code formatter..."
  pushd "$REPO_ROOT" >/dev/null 2>&1 || exit 0
  make format
  check_error
  popd >/dev/null 2>&1 || exit 0

  if ! ( test -z "$(git ls-files --exclude-standard --others)" && git diff-files --quiet ); then
    echo "${CYAN}[pre-commit]${RESET} ‚ö†Ô∏è  Code formatted, please stage the changes and commit again."
    exit 1
  fi
else
  echo "${CYAN}[pre-commit]${RESET} ‚ö†Ô∏è  Unstaged changes detected, please stage them before committing."
  echo "${CYAN}[pre-commit]${RESET} üí° If you want to commit without formatting, use ${GREEN}git commit --no-verify${RESET}."
  exit 1
fi
